<%-include("userlayout/header.ejs")%>
<div class="breadcrumbs_area">
    <div class="container">   
        <div class="row">
            <div class="col-12">
                <div class="breadcrumb_content">
                    <h3>Checkout</h3>
                    <ul>
                        <li><a href="index.html">home</a></li>
                        <li>Checkout</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>         
</div>
    <!--breadcrumbs area end-->
    
    <!--Checkout page section-->
    <div class="Checkout_section" id="accordion">
        <div class="container">
             <div class="row">
                <div class="col-12">
                     <div class="user-actions">
                         <h3> 
                             <i class="fa fa-file-o" aria-hidden="true"></i>
                             Returning customer?
                             <a class="Returning" href="#" data-bs-toggle="collapse" data-bs-target="#checkout_login" aria-expanded="true">Click here to login</a>     
 
                         </h3>
                          <div id="checkout_login" class="collapse" data-parent="#accordion">
                             <div class="checkout_info">
                                 <p>If you have shopped with us before, please enter your details in the boxes below. If you are a new customer please proceed to the Billing & Shipping section.</p>  
                                 <form action="#">  
                                     <div class="form_group">
                                         <label>Username or email <span>*</span></label>
                                         <input type="text">     
                                     </div>
                                     <div class="form_group">
                                         <label>Password  <span>*</span></label>
                                         <input type="text">     
                                     </div> 
                                     <div class="form_group group_3 ">
                                         <button type="submit">Login</button>
                                         <label for="remember_box">
                                             <input id="remember_box" type="checkbox">
                                             <span> Remember me </span>
                                         </label>     
                                     </div>
                                     <a href="#">Lost your password?</a>
                                 </form>          
                             </div>
                         </div>    
                     </div>
                     <div class="user-actions">
                         <h3> 
                             <i class="fa fa-file-o" aria-hidden="true"></i>
                             Returning customer?
                             <a class="Returning" href="#" data-bs-toggle="collapse" data-bs-target="#checkout_coupon" aria-expanded="true">Click here to enter your code</a>     
 
                         </h3>
                          <div id="checkout_coupon" class="collapse" data-parent="#accordion">
                             <div class="checkout_info coupon_info">
                                 <form action="#">
                                     <input placeholder="Coupon code" type="text">
                                     <button type="submit">Apply coupon</button>
                                 </form>
                             </div>
                         </div>    
                     </div>    
                </div>
             </div>
             <div class="checkout_form">
                 <div class="row">
                     <div class="col-lg-6 col-md-6">
                         
                           
                       
                             <% if(userAddress.length > 0){%>
                              <%  userAddress.forEach((address,index)=>{%>
                                <div class="row">
                                    <div class="card w-75">
                                        <div class="card-body">
                                            <label class="radio-container"></label>
                                            <input type="radio" name="address" id="addressRadio" value="<%=address._id%>"  <%if(index==0){%>checked<%}%>>
                                            <span class="checkmark"></span>
                                            </label>
                                    
                                            <h5 class="card-title"><%= address.name %></h5>
                                            <span><strong><%= address.phone %></strong></span>
                                            <p class="card-text"><%= address.houseno %> <%= address.landmark %> <%= address.city %> <%= address.state %> <%= address.pincode %></p>

                                        </div>
                                        <p>
                                            <a href="/add-address">add addresss</a>
                                            <a href="/edit-address/?id=<%=address._id%>">edit addresss</a>

                                            
                                        </p>
                                    </div>
                                </div>
                         
                             <% })%>
                              
                                  <%} else {%>
                             <h3>Address Details</h3>
                             <form>
                                <div class="row">
                                 <div class="col-lg-6 mb-20">
                                     <label> Name <span>*</span></label>
                                     <input type="text" name="name" id="uname">    
                                 </div>
                               
 
                                 <div class="col-12 mb-20">
                                     <label>Street address<span>*</span></label>
                                     <input placeholder="House number and street name" type="text" name="houseno" id="houseno">     
                                 </div>
                                 <div class="col-12 mb-20">
                                    <label>Landmark<span>*</span></label>
                                    <input placeholder="landmark or Area" type="text" name="landmark" id="landmark">     
                                </div>

                                <div class="col-6 mb-20">
                                    <label>pincode<span>*</span></label>
                                    <input  type="number" name="pincode" id="pincode">     
                                </div>
                                 
                                 <div class="col-12 mb-20">
                                     <label>Town / City <span>*</span></label>
                                     <input  type="text" name="city" id="city">    
                                 </div> 
                                  <div class="col-12 mb-20">
                                     <label>State  <span>*</span></label>
                                     <input type="text" name="state" id="state">    
                                 </div> 
                                 <div class="col-lg-6 mb-20">
                                     <label>Phone<span>*</span></label>
                                     <input type="text" name="phone" id="phone"> 
 
                                 </div> 
                                  <div class="col-lg-6 mb-20">
                                     <label> Email Address <span>*</span></label>
                                       <input type="text" name="email" id="email"> 
 
                                 </div> 
                                 <div class="col-12 mb-20">
                                    <label for="country">country <span>*</span></label>
                                    <input type="text" name="country" id="country">                                    
                                </div>
                            </div>

                             <%}%>
                           	    
                             
                         
                     </div>
                     <div class="col-lg-6 col-md-6">
                         
                             <h3>Your order</h3> 
                             <div class="order_table table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <%let sum=0%>
                                        <%if(locals.productsInCart){%>
                                        <% productsInCart.forEach((cart)=>{%>
                                        <tr>
                                            <%sum=sum+(cart.productid.salesprice*cart.qty)%>
                                            <td> <%=cart.productid.name%> <strong> × <%=cart.qty%></strong></td>
                                            <td class="saleprice"> <%=cart.productid.salesprice*cart.qty%></td>
                                        </tr>

                                       <% })%>
                                       <% }%>
                                          
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th>Cart Subtotal</th>
                                            
                                            <td><%=sum%></td>
                                        </tr>
                                        <tr>
                                            <th>Shipping</th>
                                            <td><strong>$5.00</strong></td>
                                        </tr>
                                        <tr class="order_total">
                                            <th>Order Total</th>
                                            <td><strong><%=sum%></strong></td>
                                            <input type="hidden" id="sum" value="<%=sum%>" name="sum">
                                        </tr>
                                    </tfoot>
                                </table>     
                            </div>
                            <div class="payment_method">
                               <div class="panel-default">
                                    <input id="payment" name="check_method" type="radio" data-bs-target="createp_account" value="cod" class="payment"/>
                                    <label for="payment" data-bs-toggle="collapse" data-bs-target="#method" aria-controls="method">COD</label>

                                    <div id="method" class="collapse one" data-parent="#accordion">
                                        <div class="card-body1">
                                           <p>Please send a check to Store Name, Store Street, Store Town, Store State / County, Store Postcode.</p>
                                        </div>
                                    </div>
                                </div> 
                                <div class="panel-default">
                                    <input id="payment_defult" name="check_method" type="radio" data-bs-target="createp_account" value="razorpay" class="payment"/>
                                    <label for="payment_defult" data-bs-toggle="collapse" data-bs-target="#collapsedefult" aria-controls="collapsedefult">PayPal <img src="assets/img/icon/papyel.png" alt=""></label>
                                    
                                    <div id="collapsedefult" class="collapse one" data-parent="#accordion">
                                        <div class="card-body1">
                                           <p>Pay via PayPal; you can pay with your credit card if you don’t have a PayPal account.</p> 
                                        </div>
                                    </div>
                                </div>
                                <div class="order_button">
                                    <button type="button" onclick="paymentProceed()" >Proceed Payment</button> 
                                </div>    
                            </div> 
                        </form>         
                    </div>
                </div> 
            </div> 
        </div>       
    </div>
    <script>
        console.log("hello")
   const uname = document.getElementById("uname")
   const houseno = document.getElementById("houseno")
   const landmark = document.getElementById("landmark")
   const pincode = document.getElementById("pincode")
   const city = document.getElementById("city")
   const state = document.getElementById("state")
   const phone = document.getElementById("phone")
   const email = document.getElementById("email")
   const addresstag=document.getElementById("addressRadio")
   const sum=document.getElementById("sum").value
   const paymentradio=document.querySelectorAll('.payment')
 


   
  console.log("going to enter function");
   
   
   async function paymentProceed(){ 
    console.log("hello enterd function")
    let  selectedpayment
 for(i=0;i<2;i++){
    if(paymentradio[i].checked == true){
    selectedpayment=paymentradio[i].value
    }
 }
  
const addresstag=document.getElementById("addressRadio")
console.log(addresstag)
let address

   if(addresstag && addresstag.checked){
    console.log("hi")
     address= addresstag.value
   }
   else{
    address="nill"
   }
   let payment
   
   console.log("payment",selectedpayment)

    postdata={
        name:uname ? uname.value:'nill',
        houseno:houseno? houseno.value:'nill',
        landmark:landmark? landmark.value:'nill',
        pincode:pincode? pincode.value:'nill',
        city:city? city.value:'nill',
        state:state? state.value:'nill',
        phone:phone? phone.value:'nill',
        email:email? email.value:'nill',
        address:address,
        check_method:selectedpayment,
        sum:sum
    }
    url='/checkout'
  const res = await fetch(url,{method:'POST',headers:{
    'Content-Type': 'application/json',

  },body:JSON.stringify(postdata)})

const response=await res.json()

if(response.codSucess == "sucess"){
    window.location.href="/ordersuccess"
}
else{

    generatePayment(response)
  
}

   }
   function generatePayment(order){
    console.log("hi")
    var options = {
    "key": "rzp_test_aykCH4paLrlr2m", 
    "amount": order.amount,
    "currency": "INR",
    "name": "Genex clothing", 
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id":order.id , 
    "handler": function (response){
   
        paymentVerify(response,order)
    },
    "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
        "name": "Gaurav Kumar", //your customer's name
        "email": "gaurav.kumar@example.com", 
        "contact": "9000090000"  //Provide the customer's phone number for better conversion rates 
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){
    paymentVerify(response,order)
   })
rzp1.open();
   }
async function paymentVerify(payment,order){
    console.log("payment verified function ")
    url=`/verifyPayment`
  let postdata={
      payment:payment,
      order:order  
    }
const response= await fetch(url,{method:'POST',headers:{
    'Content-Type': 'application/json',

  },body:JSON.stringify(postdata)})


const data=await response.json()
}

    </script>

<%-include("userlayout/footer.ejs")%>
